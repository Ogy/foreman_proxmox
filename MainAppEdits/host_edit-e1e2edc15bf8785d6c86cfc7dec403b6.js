function update_nics(e){var t=$("form").serialize().replace("method=put","method=post");$("#network").html(spinner_placeholder(__("Loading interfaces information ..."))),$("#network_tab a").removeClass("tab-error");var a=$("#network_tab").data("refresh-url");$.ajax({type:"post",url:a,data:t,complete:function(){},error:function(e,t,a){$("#network").html(Jed.sprintf(__("Error loading interfaces information: %s"),a)),$("#network_tab a").addClass("tab-error")},success:function(t){$("#network").html(t),$("#network").find(".alert-danger").length>0&&$("#network_tab a").addClass("tab-error"),update_interface_table(),e()}})}function computeResourceSelected(e){providerSpecificNICInfo=null;var t=$(e).val();if(""==t&&/compute_resource/.test($(e).attr("name")))$("#model_name").show(),$("#compute_resource").empty(),$("#vm_details").empty(),$("#compute_resource_tab").hide(),$("#compute_profile").hide(),update_capabilities("build");else{$("#model_name").hide(),$("#compute_resource_tab").show(),$("#compute_profile").show(),$("#vm_details").empty();var a=$("form").serialize().replace("method=put","method=post");$("#compute_resource").html(spinner_placeholder(__("Loading virtual machine information ..."))),$("#compute_resource_tab a").removeClass("tab-error"),$(e).indicator_show();var o=$(e).attr("data-url");$.ajax({type:"post",url:o,data:a,complete:function(){$(e).indicator_hide()},error:function(e,t,a){$("#compute_resource").html(Jed.sprintf(__("Error loading virtual machine information: %s"),a)),$("#compute_resource_tab a").addClass("tab-error")},success:function(e){$("#compute_resource").html(e),$("#compute_resource").find(".alert-danger").length>0&&$("#compute_resource_tab a").addClass("tab-error"),update_capabilities($("#capabilities").val())}})}update_nics(function(){interface_subnet_selected(primary_nic_form().find("select.interface_subnet"))})}function update_capabilities(e){$("#image_provisioning").empty(),$("#image_selection").appendTo($("#image_provisioning")),update_provisioning_image(),$("#manage_network").empty(),$("#subnet_selection").appendTo($("#manage_network"));var t=/build/i.test(e),a=/image/i.test(e);t?($("#manage_network_build").show(),$("#host_provision_method_build").click(),build_provision_method_selected()):($("#manage_network_build").hide(),$("#host_provision_method_image").click(),image_provision_method_selected()),t&&a?$("#provisioning_method").show():$("#provisioning_method").hide(),multiSelectOnLoad()}function submit_host(){var e=window.location.pathname.replace(/\/edit$|\/new$/,"");return/\/clone$/.test(window.location.pathname)&&(e=foreman_url("/hosts")),$("#host_submit").attr("disabled",!0),stop_pooling=!1,$("body").css("cursor","progress"),clear_errors(),animate_progress(),$.ajax({type:"POST",url:e,data:$("form").serialize(),success:function(e){$("#host-progress").hide(),$("#content").replaceWith($("#content",e)),$(document.body).trigger("ContentLoad"),$("[data-history-url]").exists()&&history.pushState({},"Host show",$("[data-history-url]").data("history-url"))},error:function(e){$("#content").html(e.responseText)},complete:function(){stop_pooling=!0,$("body").css("cursor","auto"),$("#host_submit").attr("disabled",!1)}}),!1}function clear_errors(){$(".error").children().children(".help-block").remove(),$(".error").removeClass("error"),$(".tab-error").removeClass("tab-error"),$(".alert-danger").remove()}function animate_progress(){1!=stop_pooling&&setTimeout(function(){var e=$("#host_progress_report_id").data("url");"undefined"!=typeof e&&$.get(e,function(e){update_progress(e),animate_progress()})},1600)}function update_progress(e){var t=$("p",e).length;if(0!=t&&1!=stop_pooling){var a=$(".glyphicon-check",e).length,o=$(".glyphicon-remove",e).length;$("#host-progress").show(),o>0?$(".progress-bar").addClass("progress-bar-danger"):$(".progress-bar").removeClass("progress-bar-danger"),$(".progress-bar").width(a/t*100+"%"),$("#tasks_progress").replaceWith(e)}}function load_puppet_class_parameters(e){var t=$(e).attr("data-class-id"),a=$("form").data("id");if(!($("#puppetclass_"+t+"_params_loading").length>0||$('[id^="#puppetclass_'+t+'_params\\["]').length>0)){var o=$(e).attr("data-url"),r=$("form").serialize().replace("method=put","method=post");if(r=o.match("hostgroups")?r+"&hostgroup_id="+a:r+"&host_id="+a,void 0!=o){var s=$('<tr id="puppetclass_'+t+'_params_loading"><td colspan="5">'+spinner_placeholder(__("Loading parameters..."))+"</td></tr>");$("#inherited_puppetclasses_parameters").append(s),$.ajax({url:o,type:"post",data:r,success:function(e,t,a){var o=$(e);s.replaceWith(o),o.find('a[rel="popover"]').popover({html:!0}),o.find(".error").length>0&&$("#params-tab").addClass("tab-error")}})}}}function hostgroup_changed(e){var t=$("form").data("id"),a=$("form").data("type-changed");t?a?update_form(e,{data:"&host[id]="+t}):void 0==a?update_form(e):(update_puppetclasses(e),reload_host_params()):update_form(e)}function organization_changed(e){update_form(e)}function location_changed(e){update_form(e)}function update_form(e,t){t=t||{};var a=$(e).data("url"),o=$("form").serialize().replace("method=put","method=post");t.data&&(o+=t.data),$(e).indicator_show(),$.ajax({type:"post",url:a,data:o,complete:function(){$(e).indicator_hide()},success:function(e){$("form").replaceWith(e),multiSelectOnLoad(),$("#host_compute_resource_id").val()||$("#host_compute_resource_id").change(),update_capabilities($("#host_compute_resource_id").val()?$("#capabilities").val():"build"),$(document.body).trigger("ContentLoad")}})}function subnet_contains(e,t,a){var o=_to_int(a),r=_to_int(e),s=32-parseInt(t);return o>>s==r>>s}function _to_int(e){for(var t=e.split("."),a=0,o=0;3>=o;o++)a=256*a+parseInt(t[o]);return a}function architecture_selected(e){var t=attribute_hash(["architecture_id","organization_id","location_id"]),a=$(e).attr("data-url");$(e).indicator_show(),$.ajax({data:t,type:"post",url:a,complete:function(){reloadOnAjaxComplete(e)},success:function(e){$("#os_select").html(e)}})}function os_selected(e){var t=attribute_hash(["operatingsystem_id","organization_id","location_id"]),a=$(e).attr("data-url");$(e).indicator_show(),$.ajax({data:t,type:"post",url:a,complete:function(){reloadOnAjaxComplete(e)},success:function(e){$("#media_select").html(e),reload_host_params()}}),update_provisioning_image()}function update_provisioning_image(){var e=$('[name$="[compute_resource_id]"]').val(),t=$('[name$="[architecture_id]"]').val(),a=$('[name$="[operatingsystem_id]"]').val();if(void 0!=e&&""!=e&&""!=t&&""!=a){var o="operatingsystem="+a+" architecture="+t,r=$("#image_selection select").empty();$.ajax({data:"search="+encodeURIComponent(o),type:"get",url:foreman_url("/compute_resources/"+e+"/images"),dataType:"json",success:function(e){if($.each(e,function(){r.append($("<option />").val(this.image.uuid).text(this.image.name))}),r.find("option").length>0&&$("#host_provision_method_image")[0].checked)if("Libvirt"==$("#provider").val())libvirt_image_selected(r);else if("Ovirt"==$("#provider").val()){var t=$("#host_compute_attributes_template");t.length>0&&(t.val(r.val()),ovirt_templateSelected(r))}}})}}function medium_selected(e){var t=$(e).attr("data-url"),a=$(e).attr("data-type"),o="hosts"==a?"host":"hostgroup",r={};r[o]=attribute_hash(["medium_id","operatingsystem_id","architecture_id"]),r[o].use_image="checked"==$("*[id*=use_image]").attr("checked"),$.ajax({data:r,type:"post",url:t,success:function(e){$("#image_details").html(e)}})}function use_image_selected(e){var t=$(e).attr("data-url"),a=$(e).attr("data-type"),o="hosts"==a?"host":"hostgroup",r={};r[o]=attribute_hash(["medium_id","operatingsystem_id","architecture_id","model_id"]),r[o].use_image="checked"==$(e).attr("checked"),$.ajax({data:r,type:"post",url:t,success:function(e){var t=$("*[id*=image_file]");r[o].use_image?""==t.val()&&t.val(e.image_file):t.val(""),t.attr("disabled",!r[o].use_image)}})}function override_param(e){var t=$(e).closest("tr"),a=t.find("[id^=name_]").text(),o=t.find("[id^=value_]"),r=o.val();$("#parameters").find(".btn-success").click();var s=t.closest(".tab-pane").find("td.col-md-6 [id*=host_host_parameters]:visible").parent().parent().last();s.find("[id$=_name]").val(a),s.find("td.col-md-6 [id$=_value]").val(r==o.data("hidden-value")?"":r),mark_params_override()}function override_class_param(e){var t=$(e).closest('tr[id^="puppetclass_"][id*="_params\\["][id$="\\]"]'),a=t.attr("id").replace(/puppetclass_\d+_params\[(\d+)\]/,"$1"),o=t.find("[data-property=class]").text(),r=t.find("[data-property=name]").text(),s=t.find("[data-property=value]").val(),i=t.find("[data-property=type]").text();$("#puppetclasses_parameters").find(".btn-success").click();var n=t.closest(".tab-pane").find("[id*=_lookup_values]:visible").last().parents(".form-group");n.find("[data-property=lookup_key_id]").val(a),n.find("[data-property=class]").val(o),n.find("[data-property=name]").val(r),n.find("[data-property=value]").val(s),n.find("[data-property=type]").val(i),mark_params_override()}function reload_host_params(){var e=$("form").data("id"),t=$("#params-tab").data("url"),a=$("[data-submit='progress_bar']").serialize().replace("method=put","method=post");if(t.match("hostgroups")){var o=$("#hostgroup_parent_id").val();a=a+"&hostgroup_id="+e+"&hostgroup_parent_id="+o}else a=a+"&host_id="+e;load_with_placeholder("inherited_parameters",t,a)}function reload_puppetclass_params(){var e=$("form").data("id"),t=$("#params-tab").data("url2"),a=$("[data-submit='progress_bar']").serialize().replace("method=put","method=post");a=t.match("hostgroups")?a+"&hostgroup_id="+e:a+"&host_id="+e,load_with_placeholder("inherited_puppetclasses_parameters",t,a)}function load_with_placeholder(e,t,a){if(void 0!=t){var o=$('<tr id="'+e+'_loading" ><td colspan="4">'+spinner_placeholder(__("Loading parameters..."))+"</td></tr>");$("#"+e+" tbody").replaceWith(o),$.ajax({type:"post",url:t,data:a,success:function(t,a,r){o.closest("#"+e).replaceWith($(t)),mark_params_override()}})}}function onHostEditLoad(){update_interface_table(),$("#host-conflicts-modal").modal({show:"true",backdrop:"static"}),$("#host-conflicts-modal").click(function(){$("#host-conflicts-modal").modal("hide")}),$("#image_selection").appendTo($("#image_provisioning")),$("#params-tab").on("shown",function(){mark_params_override()}),$("#supports_update")&&!$("#supports_update").data("supports-update")&&disable_vm_form_fields()}function build_provision_method_selected(){$("#network_provisioning").show(),$("#image_provisioning").hide(),$("#image_selection select").attr("disabled",!0),"Ovirt"==$("#provider").val()&&$("#host_compute_attributes_template").attr("disabled",!1)}function image_provision_method_selected(){$("#network_provisioning").hide(),$("#image_provisioning").show(),$("#network_selection select").attr("disabled",!0);var e=$("#image_selection select");if(e.attr("disabled",!1),"Libvirt"==$("#provider").val())libvirt_image_selected(e);else if("Ovirt"==$("#provider").val()){var t=$("#host_compute_attributes_template");t.length>0&&(t.attr("disabled",!0),t.val(e.val()),ovirt_templateSelected(e))}}function interface_domain_selected(e){preserve_selected_options($(e));var t=e.value,a=$(e).closest("fieldset").find("[id$=_subnet_id]").empty();a.attr("disabled",!0),$(e).indicator_show();var o=$(e).attr("data-url"),r=$("#host_organization_id :selected").val(),s=$("#host_location_id :selected").val();$.ajax({data:{domain_id:t,organization_id:r,location_id:s,"interface":!0},type:"post",url:o,dataType:"json",success:function(t){t.length>1&&a.append($("<option />").val(null).text(__("Please select"))),$.each(t,function(){a.append($("<option />").val(this.subnet.id).text(this.subnet.to_label))}),a.find("option").length>0?(a.attr("disabled",!1),a.change()):(a.append($("<option />").text(__("No subnets"))),a.attr("disabled",!0)),reloadOnAjaxComplete(e),a.filter("select").select2({allowClear:!0})}})}function interface_subnet_selected(e){preserve_selected_options($(e));var t=$(e).val();if(""!=t){var a=$(e).closest("fieldset").find("input[id$=_ip]");a.attr("disabled",!0),$(e).indicator_show();var o=$(e).children(":selected").text();if(0!=o.length&&-1!=o.search(/^.+ \([0-9\.\/]+\)/)){var r=o.replace(/^.+\(/,"").replace(")","").split("/"),s=r[0],i=r[1];if(subnet_contains(s,i,a.val()))return a.attr("disabled",!1),void $(e).indicator_hide()}var n=$(e).closest("fieldset").find("input[id$=_mac]"),l=$(e).attr("data-url"),u=$("#host_organization_id :selected").val(),d=$("#host_location_id :selected").val(),c=$(active_interface_forms()).find(".interface_ip").map(function(){return $(this).val()}).get();c.push(a.val());var p={subnet_id:t,host_mac:n.val(),organization_id:u,location_id:d,taken_ips:c};$.ajax({data:p,type:"post",url:l,dataType:"json",success:function(e){a.val(e.ip),n.val(e.mac),update_interface_table()},error:function(e,t,o){a.addClass("tab-error"),a.val(Jed.sprintf(__("Error generating IP: %s"),o))},complete:function(){$(e).indicator_hide(),a.attr("disabled",!1)}})}}function interface_type_selected(e){var t=$(e).closest("fieldset"),a=t.serializeArray();a.push({name:"host[compute_resource_id]",value:$("#host_compute_resource_id").val()}),request=$.ajax({data:a,type:"GET",url:t.attr("data-url"),dataType:"script"}),request.done(function(){password_caps_lock_hint(),$("#interfaceModal").find('a[rel="popover-modal"]').popover({html:!0}),$("select").select2({allowClear:!0})})}function disable_vm_form_fields(){$("#update_not_supported").show(),$("[id^=host_compute_attributes]").each(function(){$(this).attr("disabled","disabled")})}function resizeTextareas(e){e.find("textarea").each(function(){void 0!==this.scrollHeight&&(this.scrollHeight<=100?this.style.height=this.scrollHeight+parseInt(this.style.paddingTop)+parseInt(this.style.paddingBottom)+"px":this.style.height="100px")})}function selectedSubnetHasIPAM(){var e=$("#host_subnet_id"),t=e.val(),a=e.data("subnets");return""==t?!0:a[t].ipam}$(document).on("ContentLoad",function(){onHostEditLoad()}),$(document).on("AddedClass",function(e,t){load_puppet_class_parameters(t)}),$(document).on("click","#params-tab",function(){resizeTextareas($("#params"))});var stop_pooling;$(document).on("submit","[data-submit='progress_bar']",function(){return submit_host(),!1}),$(document).on("change","#host_provision_method_build",build_provision_method_selected),$(document).on("change","#host_provision_method_image",image_provision_method_selected),$(document).on("change",".interface_domain",function(){interface_domain_selected(this)}),$(document).on("click",".suggest_new_ip",function(e){$(this).closest("fieldset").find(".interface_ip").val(""),interface_subnet_selected($(this).closest("fieldset").find("select.interface_subnet")),e.preventDefault()}),$(document).on("change",".interface_subnet",function(){interface_subnet_selected(this)}),$(document).on("change",".interface_type",function(){interface_type_selected(this)});