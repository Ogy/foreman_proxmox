function update_nics(e){var t=serializeForm().replace("method=put","method=post");$("#network").html(spinner_placeholder(__("Loading interfaces information ..."))),$("#network_tab a").removeClass("tab-error");var a=$("#network_tab").data("refresh-url");$.ajax({type:"post",url:a,data:t,complete:function(){},error:function(e,t,a){$("#network").html(Jed.sprintf(__("Error loading interfaces information: %s"),a)),$("#network_tab a").addClass("tab-error")},success:function(t){$("#network").html(t),$("#network").find(".alert-danger").length>0&&$("#network_tab a").addClass("tab-error"),update_interface_table(),e()}})}function computeResourceSelected(e){providerSpecificNICInfo=null;var t=$(e).val();if(""==t&&/compute_resource/.test($(e).attr("name")))$("#model_name").show(),$("#compute_resource").empty(),$("#vm_details").empty(),$("#compute_resource_tab").hide(),$("#compute_profile").hide(),update_capabilities("build"),update_nics(function(){interface_subnet_selected(primary_nic_form().find("select.interface_subnet"))});else{$("#model_name").hide(),$("#compute_resource_tab").show(),$("#compute_profile").show(),$("#vm_details").empty();var a=serializeForm().replace("method=put","method=post");$("#compute_resource").html(spinner_placeholder(__("Loading virtual machine information ..."))),$("#compute_resource_tab a").removeClass("tab-error"),$(e).indicator_show();var r=$(e).attr("data-url");$.ajax({type:"post",url:r,data:a,complete:function(){$(e).indicator_hide(),update_nics(function(){interface_subnet_selected(primary_nic_form().find("select.interface_subnet"))})},error:function(e,t,a){$("#compute_resource").html(Jed.sprintf(__("Error loading virtual machine information: %s"),a)),$("#compute_resource_tab a").addClass("tab-error")},success:function(e){$("#compute_resource").html(e),$("#compute_resource").find(".alert-danger").length>0&&$("#compute_resource_tab a").addClass("tab-error"),update_capabilities($("#capabilities").val())}})}}function update_capabilities(e){$("#image_provisioning").empty(),$("#image_selection").appendTo($("#image_provisioning")),update_provisioning_image(),$("#manage_network").empty(),$("#subnet_selection").appendTo($("#manage_network"));var t=/build/i.test(e),a=/image/i.test(e);t?($("#manage_network_build").show(),$("#host_provision_method_build").click(),build_provision_method_selected()):($("#manage_network_build").hide(),$("#host_provision_method_image").click(),image_provision_method_selected()),t&&a?$("#provisioning_method").show():$("#provisioning_method").hide(),multiSelectOnLoad()}function submit_with_all_params(){var e=window.location.pathname.replace(/\/edit$|\/new|\/\d+.*\/nest$/,"");return e.match("hostgroups")?resource="hostgroup":resource="host",resources=resource+"s",capitalized_resource=resource[0].toUpperCase+resource.slice(1),/\/clone$/.test(window.location.pathname)&&(e=foreman_url("/"+resources)),$('form input[type="submit"]').attr("disabled",!0),stop_pooling=!1,$("body").css("cursor","progress"),clear_errors(),animate_progress(),$.ajax({type:"POST",url:e,data:serializeForm(),success:function(e){$("#"+resource+"-progress").hide(),$("#content").replaceWith($("#content",e)),$(document.body).trigger("ContentLoad"),$("[data-history-url]").exists()&&history.pushState({},capitalized_resource+" show",$("[data-history-url]").data("history-url"))},error:function(e){$("#content").html(e.responseText)},complete:function(){stop_pooling=!0,$("body").css("cursor","auto"),$('form input[type="submit"]').attr("disabled",!1)}}),!1}function clear_errors(){$(".error").children().children(".help-block").remove(),$(".error").removeClass("error"),$(".tab-error").removeClass("tab-error"),$(".alert-danger").remove()}function animate_progress(){1!=stop_pooling&&setTimeout(function(){var e=$("#host_progress_report_id").data("url");"undefined"!=typeof e&&$.get(e,function(e){update_progress(e),animate_progress()})},1600)}function update_progress(e){var t=$("p",e).length;if(0!=t&&1!=stop_pooling){var a=$(".glyphicon-check",e).length,r=$(".glyphicon-remove",e).length;$("#host-progress").show(),r>0?$(".progress-bar").addClass("progress-bar-danger"):$(".progress-bar").removeClass("progress-bar-danger"),$(".progress-bar").width(a/t*100+"%"),$("#tasks_progress").replaceWith(e)}}function load_puppet_class_parameters(e){var t=$(e).attr("data-class-id"),a=$("form").data("id");if(!($("#puppetclass_"+t+"_params_loading").length>0||$('[id^="#puppetclass_'+t+'_params\\["]').length>0)){var r=$(e).attr("data-url"),o=serializeForm().replace("method=put","method=post");if(o=r.match("hostgroups")?o+"&hostgroup_id="+a:o+"&host_id="+a,void 0!=r){var i=$('<tr id="puppetclass_'+t+'_params_loading"><td colspan="5">'+spinner_placeholder(__("Loading parameters..."))+"</td></tr>");$("#inherited_puppetclasses_parameters").append(i),$.ajax({url:r,type:"post",data:o,success:function(e,t,a){var r=$(e);i.replaceWith(r),r.find('a[rel="popover"]').popover(),r.find(".error").length>0&&$("#params-tab").addClass("tab-error")}})}}}function hostgroup_changed(e){var t=$("form").data("id"),a=$("form").data("type-changed");t?a?update_form(e,{data:"&host[id]="+t}):void 0==a?update_form(e):(set_inherited_value(e),update_puppetclasses(e),reload_host_params()):(reset_explicit_values(e),set_inherited_value(e),update_form(e))}function reset_explicit_values(e){$("[name=is_overridden_btn]").each(function(e,t){var a=$(t),r=a.closest(".input-group").find(".form-control");r.attr("disabled",!0)})}function set_inherited_value(e){var t=$(e).data("had-hostgroup");if(!t){var a=""!=e.value;$("[name=is_overridden_btn]").each(function(e,t){var r=$(t),o=r.hasClass("active"),i=r.data("explicit");!i&&(a&&!o||!a&&o)&&disableButtonToggle(r,!1)})}}function organization_changed(e){update_form(e)}function location_changed(e){update_form(e)}function update_form(e,t){t=t||{};var a=$(e).data("url"),r=serializeForm().replace("method=put","method=post");t.data&&(r+=t.data),$(e).indicator_show(),$.ajax({type:"post",url:a,data:r,complete:function(){$(e).indicator_hide()},success:function(e){$("form").replaceWith(e),multiSelectOnLoad(),$("#host_compute_resource_id").val()||$("#host_compute_resource_id").change(),update_capabilities($("#host_compute_resource_id").val()?$("#capabilities").val():"build"),$(document.body).trigger("ContentLoad")}})}function serializeForm(){return $("form").serialize()}function subnet_contains(e,t,a){var r=_to_int(a),o=_to_int(e),i=32-parseInt(t);return r>>i==o>>i}function _to_int(e){for(var t=e.split("."),a=0,r=0;3>=r;r++)a=256*a+parseInt(t[r]);return a}function architecture_selected(e){var t=attribute_hash(["architecture_id","organization_id","location_id"]),a=$(e).attr("data-url");$(e).indicator_show(),$.ajax({data:t,type:"post",url:a,complete:function(){reloadOnAjaxComplete(e)},success:function(e){$("#os_select").html(e)}})}function os_selected(e){var t=attribute_hash(["operatingsystem_id","organization_id","location_id"]),a=$(e).attr("data-url");$(e).indicator_show(),$.ajax({data:t,type:"post",url:a,complete:function(){reloadOnAjaxComplete(e)},success:function(e){$("#media_select").html(e),reload_host_params()}}),update_provisioning_image()}function update_provisioning_image(){var e=$('[name$="[compute_resource_id]"]').val(),t=$('[name$="[architecture_id]"]').val(),a=$('[name$="[operatingsystem_id]"]').val();if(void 0!=e&&""!=e&&""!=t&&""!=a){var r="operatingsystem="+a+" architecture="+t,o=$("#image_selection select").empty();$.ajax({data:"search="+encodeURIComponent(r),type:"get",url:foreman_url("/compute_resources/"+e+"/images"),dataType:"json",success:function(e){if($.each(e,function(){o.append($("<option />").val(this.image.uuid).text(this.image.name))}),o.find("option").length>0&&$("#host_provision_method_image")[0].checked)if("Libvirt"==$("#provider").val())libvirt_image_selected(o);else if("Ovirt"==$("#provider").val()){var t=$("#host_compute_attributes_template");t.length>0&&(t.val(o.val()),ovirt_templateSelected(o))}}})}}function medium_selected(e){var t=$(e).attr("data-url"),a=$(e).attr("data-type"),r="hosts"==a?"host":"hostgroup",o={};o[r]=attribute_hash(["medium_id","operatingsystem_id","architecture_id"]),o[r].use_image="checked"==$("*[id*=use_image]").attr("checked"),$.ajax({data:o,type:"post",url:t,success:function(e){$("#image_details").html(e)}})}function use_image_selected(e){var t=$(e).attr("data-url"),a=$(e).attr("data-type"),r="hosts"==a?"host":"hostgroup",o={};o[r]=attribute_hash(["medium_id","operatingsystem_id","architecture_id","model_id"]),o[r].use_image="checked"==$(e).attr("checked"),$.ajax({data:o,type:"post",url:t,success:function(e){var t=$("*[id*=image_file]");o[r].use_image?""==t.val()&&t.val(e.image_file):t.val(""),t.attr("disabled",!o[r].use_image)}})}function override_param(e){var t=$(e).closest("tr"),a=t.find("[id^=name_]").text(),r=t.find("[id^=value_]"),o=r.val();$("#parameters").find(".btn-success").click();var i=$("#parameters").find(".fields").last();i.find("[id$=_name]").val(a),i.find("[id$=_value]").val(o==r.data("hidden-value")?"":o),mark_params_override()}function override_class_param(e){var t=$(e).closest('tr[id^="puppetclass_"][id*="_params\\["][id$="\\]"]'),a=t.attr("id").replace(/puppetclass_\d+_params\[(\d+)\]/,"$1"),r=t.find("[data-property=class]").text(),o=t.find("[data-property=name]").text(),i=t.find("[data-property=value]").val(),s=t.find("[data-property=type]").text(),n=t.find("[data-property=class]").children("span").attr("data-original-title"),d=t.find("[data-property=name]").children("span").attr("data-original-title");$("#puppetclasses_parameters").find(".btn-success").click();var c=t.closest(".tab-pane").find("[id*=_lookup_values]:visible").last().parents("tr");c.find("[data-property=lookup_key_id]").val(a),c.find("[data-property=class]").text(r),c.find("[data-property=name]").text(o),c.find("[data-property=value]").val(i),c.find("[data-property=type]").val(s),void 0!=d&&c.find("[data-property=name]")[0].setAttribute("title",d),void 0!=n&&c.find("[data-property=class]")[0].setAttribute("title",n),mark_params_override()}function reload_host_params(){var e=$("form").data("id"),t=$("#params-tab").data("url"),a=$("[data-submit='progress_bar']").serialize().replace("method=put","method=post");if(t.match("hostgroups")){var r=$("#hostgroup_parent_id").val();a=a+"&hostgroup_id="+e+"&hostgroup_parent_id="+r}else a=a+"&host_id="+e;load_with_placeholder("inherited_parameters",t,a)}function reload_puppetclass_params(){var e=$("form").data("id"),t=$("#params-tab").data("url2"),a=$("[data-submit='progress_bar']").serialize().replace("method=put","method=post");a=t.match("hostgroups")?a+"&hostgroup_id="+e:a+"&host_id="+e,load_with_placeholder("inherited_puppetclasses_parameters",t,a)}function load_with_placeholder(e,t,a){if(void 0!=t){var r=$('<tr id="'+e+'_loading" ><td colspan="4">'+spinner_placeholder(__("Loading parameters..."))+"</td></tr>");$("#"+e+" tbody").replaceWith(r),$.ajax({type:"post",url:t,data:a,success:function(t,a,o){r.closest("#"+e).replaceWith($(t)),mark_params_override()}})}}function onHostEditLoad(){update_interface_table(),$("#host-conflicts-modal").modal({show:"true",backdrop:"static"}),$("#host-conflicts-modal").click(function(){$("#host-conflicts-modal").modal("hide")}),$("#image_selection").appendTo($("#image_provisioning")),$("#params-tab").on("shown",function(){mark_params_override()}),$("#supports_update")&&!$("#supports_update").data("supports-update")&&disable_vm_form_fields()}function build_provision_method_selected(){$("#network_provisioning").show(),$("#image_provisioning").hide(),$("#image_selection select").attr("disabled",!0),"Ovirt"==$("#provider").val()&&$("#host_compute_attributes_template").attr("disabled",!1)}function image_provision_method_selected(){$("#network_provisioning").hide(),$("#image_provisioning").show(),$("#network_selection select").attr("disabled",!0);var e=$("#image_selection select");if(e.attr("disabled",!1),"Libvirt"==$("#provider").val())libvirt_image_selected(e);else if("Ovirt"==$("#provider").val()){var t=$("#host_compute_attributes_template");t.length>0&&(t.attr("disabled",!0),t.val(e.val()),ovirt_templateSelected(e))}}function interface_domain_selected(e){preserve_selected_options($(e));var t=e.value,a=$(e).closest("fieldset").find("[id$=_subnet_id]").empty();a.attr("disabled",!0),$(e).indicator_show();var r=$(e).attr("data-url"),o=$("#host_organization_id :selected").val(),i=$("#host_location_id :selected").val();$.ajax({data:{domain_id:t,organization_id:o,location_id:i,"interface":!0},type:"post",url:r,dataType:"json",success:function(t){t.length>1&&a.append($("<option />").val(null).text(__("Please select"))),$.each(t,function(){a.append($("<option />").val(this.subnet.id).text(this.subnet.to_label))}),a.find("option").length>0?(a.attr("disabled",!1),a.change()):(a.append($("<option />").text(__("No subnets"))),a.attr("disabled",!0)),reloadOnAjaxComplete(e),a.filter("select").select2({allowClear:!0})}})}function interface_subnet_selected(e){preserve_selected_options($(e));var t=$(e).val();if(""!=t){var a=$(e).closest("fieldset").find("input[id$=_ip]");a.attr("disabled",!0),$(e).indicator_show();var r=$(e).children(":selected").text();if(0!=r.length&&-1!=r.search(/^.+ \([0-9\.\/]+\)/)){var o=r.replace(/^.+\(/,"").replace(")","").split("/"),i=o[0],s=o[1];if(subnet_contains(i,s,a.val()))return a.attr("disabled",!1),void $(e).indicator_hide()}var n=$(e).closest("fieldset").find("input[id$=_mac]"),d=$(e).attr("data-url"),c=$("#host_organization_id :selected").val(),l=$("#host_location_id :selected").val(),p=$(active_interface_forms()).find(".interface_ip").map(function(){return $(this).val()}).get();p.push(a.val());var _={subnet_id:t,host_mac:n.val(),organization_id:c,location_id:l,taken_ips:p};$.ajax({data:_,type:"post",url:d,dataType:"json",success:function(e){a.val(e.ip),update_interface_table()},error:function(e,t,r){setError(a,Jed.sprintf(__("Error generating IP: %s"),r))},complete:function(){$(e).indicator_hide(),a.attr("disabled",!1)}})}}function interface_type_selected(e){var t=$(e).closest("fieldset"),a=t.serializeArray();a.push({name:"host[compute_resource_id]",value:$("#host_compute_resource_id").val()}),request=$.ajax({data:a,type:"GET",url:t.attr("data-url"),dataType:"script"}),request.done(function(){password_caps_lock_hint(),$("#interfaceModal").find('a[rel="popover-modal"]').popover(),$("select:not(.without_select2)").select2({allowClear:!0})})}function disable_vm_form_fields(){$("#update_not_supported").show(),$("[id^=host_compute_attributes]").each(function(){$(this).attr("disabled","disabled")})}function selectedSubnetHasIPAM(){var e=$("#host_subnet_id"),t=e.val(),a=e.data("subnets");return""==t?!0:a[t].ipam}function setError(e,t){var a=e.parents(".form-group").first();a.addClass("has-error");var r=a.children(".help-inline").first(),o=$(document.createElement("span"));o.addClass("error-message").html(t),r.prepend(o)}function clearError(e){var t=e.parents(".form-group").first();t.removeClass("has-error");var a=t.children(".help-inline").children(".error-message");a.remove()}$(document).on("ContentLoad",function(){onHostEditLoad()}),$(document).on("AddedClass",function(e,t){load_puppet_class_parameters(t)});var stop_pooling;$(document).on("submit","[data-submit='progress_bar']",function(){return submit_with_all_params(),!1}),$(document).on("change","#host_provision_method_build",build_provision_method_selected),$(document).on("change","#host_provision_method_image",image_provision_method_selected),$(document).on("change",".interface_domain",function(){interface_domain_selected(this)}),$(document).on("click",".suggest_new_ip",function(e){clearError($(this).closest("fieldset").find(".interface_ip")),interface_subnet_selected($(this).closest("fieldset").find("select.interface_subnet")),e.preventDefault()}),$(document).on("change",".interface_subnet",function(){interface_subnet_selected(this)}),$(document).on("change",".interface_type",function(){interface_type_selected(this)});